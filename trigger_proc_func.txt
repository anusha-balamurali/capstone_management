-- =========================================
-- Views
-- =========================================

-- Teams with their students and mentor
CREATE OR REPLACE VIEW Team_Student_View AS
SELECT t.Team_ID, t.Faculty_ID AS Mentor_ID, f.Name AS Mentor_Name,
       s.SRN, s.Name AS Student_Name, s.Sem
FROM Team t
JOIN Faculty f ON t.Faculty_ID = f.Faculty_ID
JOIN Team_Student ts ON t.Team_ID = ts.Team_ID
JOIN Student s ON ts.SRN = s.SRN;

-- Teams mentored by each faculty
CREATE OR REPLACE VIEW Mentor_View AS
SELECT f.Faculty_ID, f.Name AS Faculty_Name, t.Team_ID, COUNT(ts.SRN) AS Team_Size
FROM Faculty f
JOIN Team t ON f.Faculty_ID = t.Faculty_ID
LEFT JOIN Team_Student ts ON t.Team_ID = ts.Team_ID
GROUP BY f.Faculty_ID, t.Team_ID;

-- Admin view: project, team, review and panel info
CREATE OR REPLACE VIEW Admin_View AS
SELECT p.Project_ID, p.Title AS Project_Title, p.Status AS Project_Status,
       t.Team_ID, f.Faculty_ID AS Mentor_ID, f.Name AS Mentor_Name,
       r.Review_ID, rt.Review_Name AS Review_Type, r.Date AS Review_Date, r.Venue,
       GROUP_CONCAT(rp.Faculty_ID) AS Panel_Faculty_IDs
FROM Project p
JOIN Team_Project tp ON p.Project_ID = tp.Project_ID
JOIN Team t ON tp.Team_ID = t.Team_ID
JOIN Faculty f ON t.Faculty_ID = f.Faculty_ID
LEFT JOIN Review r ON r.Team_ID = t.Team_ID
LEFT JOIN Review_Type rt ON r.ReviewType_ID = rt.ReviewType_ID
LEFT JOIN Review_Panel rp ON r.Review_ID = rp.Review_ID
GROUP BY p.Project_ID, t.Team_ID, r.Review_ID;

-- =========================================
-- Functions
-- =========================================

-- a) Average marks of a team for a review
DELIMITER $$
CREATE FUNCTION GetTeamAverageMarks(team_id INT, review_id INT)
RETURNS DECIMAL(5,2)
DETERMINISTIC
BEGIN
    DECLARE avg_marks DECIMAL(5,2);

    SELECT AVG(e.Marks) INTO avg_marks
    FROM Evaluation e
    JOIN Team_Student ts ON e.SRN = ts.SRN
    WHERE ts.Team_ID = team_id AND e.Review_ID = review_id;

    RETURN IFNULL(avg_marks,0);
END$$
DELIMITER ;

-- b) Total marks of a student
DELIMITER $$
CREATE FUNCTION GetStudentTotalMarks(srn VARCHAR(20))
RETURNS DECIMAL(5,2)
DETERMINISTIC
BEGIN
    DECLARE total_marks DECIMAL(5,2);

    SELECT SUM(Marks) INTO total_marks
    FROM Evaluation
    WHERE SRN = srn;

    RETURN IFNULL(total_marks,0);
END$$
DELIMITER ;

-- =========================================
-- Procedures
-- =========================================

-- a) Add review for a team and assign panel (mentor must be included)
DELIMITER $$
CREATE PROCEDURE AddReviewForTeam(
    IN rev_type_id INT,
    IN team_id INT,
    IN rev_date DATE,
    IN venue VARCHAR(100),
    IN panel_faculty_ids TEXT -- comma separated Faculty_IDs
)
BEGIN
    DECLARE last_review_id INT;
    DECLARE mentor_id INT;

    -- get team mentor
    SELECT Faculty_ID INTO mentor_id
    FROM Team
    WHERE Team_ID = team_id;

    -- Ensure mentor is included
    IF FIND_IN_SET(mentor_id, panel_faculty_ids) = 0 THEN
        SET panel_faculty_ids = CONCAT(panel_faculty_ids, ',', mentor_id);
    END IF;

    -- Insert review
    INSERT INTO Review (ReviewType_ID, Team_ID, Date, Venue)
    VALUES (rev_type_id, team_id, rev_date, venue);

    SET last_review_id = LAST_INSERT_ID();

    -- Insert panel members
    SET @sql = CONCAT('INSERT INTO Review_Panel (Review_ID, Faculty_ID) VALUES ',
                      REPLACE(panel_faculty_ids, ',', CONCAT('),(', last_review_id, ',')), ')');
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$
DELIMITER ;

-- b) Auto-generate evaluations for a review (marks default 0)
DELIMITER $$
CREATE PROCEDURE AutoGenerateEvaluations(
    IN review_id INT,
    IN rubric_id INT
)
BEGIN
    INSERT INTO Evaluation (Faculty_ID, SRN, Rubric_ID, Project_ID, Review_ID, Marks)
    SELECT rp.Faculty_ID, ts.SRN, rubric_id, tp.Project_ID, review_id, 0
    FROM Review_Panel rp
    JOIN Review r ON rp.Review_ID = r.Review_ID
    JOIN Team_Student ts ON r.Team_ID = ts.Team_ID
    JOIN Team_Project tp ON r.Team_ID = tp.Team_ID
    WHERE r.Review_ID = review_id;
END$$
DELIMITER ;

-- =========================================
-- Triggers
-- =========================================

-- a) Ensure meeting faculty is team mentor
DELIMITER $$
CREATE TRIGGER trg_check_meeting_mentor
BEFORE INSERT ON Meeting
FOR EACH ROW
BEGIN
    DECLARE mentor_id INT;
    SELECT Faculty_ID INTO mentor_id
    FROM Team
    WHERE Team_ID = NEW.Team_ID;

    IF NEW.Faculty_ID <> mentor_id THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Faculty is not the mentor of this team';
    END IF;
END$$
DELIMITER ;

-- b) Ensure team has max 4 members
DELIMITER $$
CREATE TRIGGER trg_team_size_limit
BEFORE INSERT ON Team_Student
FOR EACH ROW
BEGIN
    DECLARE member_count INT;
    SELECT COUNT(*) INTO member_count
    FROM Team_Student
    WHERE Team_ID = NEW.Team_ID;

    IF member_count >= 4 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'A team cannot have more than 4 members';
    END IF;
END$$
DELIMITER ;

-- c) Ensure Evaluation marks <= Max_Marks
DELIMITER $$
CREATE TRIGGER trg_check_marks
BEFORE INSERT ON Evaluation
FOR EACH ROW
BEGIN
    DECLARE max_allowed DECIMAL(5,2);
    SELECT Max_Marks INTO max_allowed
    FROM Rubric
    WHERE Rubric_ID = NEW.Rubric_ID;

    IF NEW.Marks > max_allowed THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Marks exceed maximum allowed for this rubric';
    END IF;
END$$
DELIMITER ;

-- d) Ensure mentor is in review panel
DELIMITER $$
CREATE TRIGGER trg_mentor_in_panel
BEFORE INSERT ON Review_Panel
FOR EACH ROW
BEGIN
    DECLARE mentor_id INT;
    SELECT t.Faculty_ID INTO mentor_id
    FROM Team t
    JOIN Review r ON r.Team_ID = t.Team_ID
    WHERE r.Review_ID = NEW.Review_ID;

    IF NEW.Faculty_ID <> mentor_id AND
       NOT EXISTS (SELECT 1 FROM Review_Panel rp
                   JOIN Review r2 ON rp.Review_ID = r2.Review_ID
                   JOIN Team t2 ON r2.Team_ID = t2.Team_ID
                   WHERE r2.Review_ID = NEW.Review_ID AND t2.Faculty_ID = NEW.Faculty_ID) THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'The mentor must be included in the review panel';
    END IF;
END$$
DELIMITER ;

-- e) Update project status to 'Completed' if all reviews done
DELIMITER $$
CREATE TRIGGER trg_project_status_update
AFTER INSERT ON Evaluation
FOR EACH ROW
BEGIN
    DECLARE total_reviews INT;
    DECLARE eval_count INT;
    DECLARE team_project_id INT;

    SELECT Project_ID INTO team_project_id
    FROM Team_Project
    WHERE Team_ID = (SELECT Team_ID FROM Team_Student WHERE SRN = NEW.SRN);

    SELECT COUNT(*) INTO total_reviews
    FROM Review
    WHERE Team_ID = (SELECT Team_ID FROM Team_Student WHERE SRN = NEW.SRN);

    SELECT COUNT(DISTINCT Review_ID) INTO eval_count
    FROM Evaluation e
    JOIN Team_Student ts ON e.SRN = ts.SRN
    WHERE ts.Team_ID = (SELECT Team_ID FROM Team_Student WHERE SRN = NEW.SRN);

    IF total_reviews > 0 AND total_reviews = eval_count THEN
        UPDATE Project
        SET Status = 'Completed'
        WHERE Project_ID = team_project_id;
    END IF;
END$$
DELIMITER ;
